const clients = [
    {
        name: 'Gisele Meireles',
        description: 'Mentora e Infoprodutora',
        photo: 'https://cdn.discordapp.com/attachments/801210889943384105/1128464520185131168/logo.png',
        images: [
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c10.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c10.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c9.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c9.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c8.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c8.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c7.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c7.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c6.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c6.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c5.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c5.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c4.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c4.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c3.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c3.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c2.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c2.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c1.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/c1.jpg',
            },
        ]
    },
    {
        name: 'Matheus Staudinger',
        description: 'Fisioterapeuta Esportivo',
        photo: 'https://cdn.discordapp.com/attachments/801210889943384105/1128464553248825424/logo.png',
        images: [
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/2.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/2.jpg',
            },
            {
                mobile:  'https://jhonzzera.com.br/wp-content/uploads/2023/07/1.png',
                desktop:  'https://jhonzzera.com.br/wp-content/uploads/2023/07/1.png',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/3.jpg',
                desktop:'https://jhonzzera.com.br/wp-content/uploads/2023/07/3.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/4.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/4.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/5.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/5.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/6.jpg',
                desktop:  'https://jhonzzera.com.br/wp-content/uploads/2023/07/6.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/7.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/7.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/8.jpg',
                desktop:'https://jhonzzera.com.br/wp-content/uploads/2023/07/8.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/9.jpg',
                desktop:'https://jhonzzera.com.br/wp-content/uploads/2023/07/9.jpg',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/10.jpg',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/10.jpg',
            },
        ]
    },
    {
        name: 'Pure Healthy',
        description: 'O prazer de comer bem',
        photo: 'https://cdn.discordapp.com/attachments/801210889943384105/1128464577957470208/logo.png',
        images: [
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p9.png',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p9.png',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p8.png',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p8.png'
            },
            {
                mobile:  'https://jhonzzera.com.br/wp-content/uploads/2023/07/p10.png',
                desktop:  'https://jhonzzera.com.br/wp-content/uploads/2023/07/p10.png',
            },
            {
                mobile:'https://jhonzzera.com.br/wp-content/uploads/2023/07/p7.png',
                desktop:'https://jhonzzera.com.br/wp-content/uploads/2023/07/p7.png',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p6.png',
                desktop:'https://jhonzzera.com.br/wp-content/uploads/2023/07/p6.png',
            },
            {
                mobile:  'https://jhonzzera.com.br/wp-content/uploads/2023/07/p5.png',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p5.png',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p4.png',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p4.png',
            },
            {
                mobile:'https://jhonzzera.com.br/wp-content/uploads/2023/07/p3.png',
                desktop:'https://jhonzzera.com.br/wp-content/uploads/2023/07/p3.png',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p2.png',
                desktop: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p2.png',
            },
            {
                mobile: 'https://jhonzzera.com.br/wp-content/uploads/2023/07/p1.png',
                desktop:'https://jhonzzera.com.br/wp-content/uploads/2023/07/p1.png',
            },
        ]
    },
].sort(() => {

    return Math.random() - 0.5

})

const alreadyViewed = []
const elements = {
    infosTop: {
        self: document.querySelector('.slide .content .infos-top'),
        foto: document.querySelector('.slide .content .infos-top .foto'),
        clientInfos: {
            self: document.querySelector('.slide .content .infos-top .client-infos'),
            name: document.querySelector('.slide .content .infos-top .client-infos .name'),
            description: document.querySelector('.slide .content .infos-top .client-infos .description')
        },
        btnAction: document.querySelector('.slide .content .infos-top .btn-action')
    },
    slideContainer: {
        self: document.querySelector('.slide .content .slide-container'),
        actions: {
            self: document.querySelector('.slide .content .slide-container .actions'),
            childs: document.querySelectorAll('.slide .content .slide-container .actions .action'),
        },
        images: {
            self: document.querySelector('.slide .content .slide-container .images .group'),
            childs: document.querySelectorAll('.slide .content .slide-container .images .group .image'),
        }
    }
}

let imagesPerView = Number(getComputedStyle(elements.slideContainer.images.self.parentNode).getPropertyValue('--images-quantity').trim()),
    dragging = false,
    draggingLeave = false,
    startDrag = 0,
    startTranslate = 0,
    wasMobile = false,
    currentClient

window.addEventListener('load', async () => {

    const carouselResizeObserver = new ResizeObserver(async (entries) => {

        for (entry of entries){

            imagesPerView = Number(getComputedStyle(elements.slideContainer.images.self.parentNode).getPropertyValue('--images-quantity').trim())

            if((!wasMobile && document.body.clientWidth < 853) || (wasMobile && document.body.clientWidth > 853)){

                wasMobile = !wasMobile

                await renderClientToDOM(currentClient)
                return

            }

            const currentImage = Array.from(elements.slideContainer.images.childs).filter((child) => {

                return child.classList.contains('current')
                
            })[0]
            
            await scrollCarousel(currentImage)

        }

    })

    carouselResizeObserver.observe(elements.slideContainer.self)

    await renderClientToDOM()

    elements.infosTop.btnAction.addEventListener('click', async () => {

        await renderClientToDOM()
    
    })

    elements.slideContainer.actions.childs.forEach((action) => {

        action.addEventListener('click', async () => {
            
            let currentImage = Array.from(elements.slideContainer.images.childs).filter((image) => {
    
                return image.classList.contains('current')
    
            })[0]

            const currentImageIndex = Array.from(elements.slideContainer.images.childs).indexOf(currentImage)
            const direction = action.dataset.direction

            if((currentImageIndex == 0 && direction == 'left') || (currentImageIndex == elements.slideContainer.images.childs.length - 1 && direction == 'right')){

                return

            }
            
            await scrollCarousel(currentImage, direction)

        })

    })

    elements.slideContainer.images.self.addEventListener('mousedown', await dragCarousel('start'))
    elements.slideContainer.images.self.addEventListener('mousemove', await dragCarousel('move'))
    elements.slideContainer.images.self.addEventListener('mouseup', await dragCarousel('end'))
    elements.slideContainer.images.self.addEventListener('mouseleave', await dragCarousel('end'))
    
    elements.slideContainer.images.self.addEventListener('touchstart', await dragCarousel('start'))
    elements.slideContainer.images.self.addEventListener('touchmove', await dragCarousel('move'))
    elements.slideContainer.images.self.addEventListener('touchend', await dragCarousel('end'))
    elements.slideContainer.images.self.addEventListener('touchleave', await dragCarousel('end'))
    elements.slideContainer.images.self.addEventListener('touchcancel', await dragCarousel('end'))

})

async function scrollCarousel(currentImage, direction) {

    await createClones()

    elements.slideContainer.images.childs.forEach((image) => {

        image.classList.remove('hidden')
        image.classList.remove('current')

    })

    const newCurrentImage = direction ? currentImage[`${direction == 'right' ? 'next' : 'previous'}Sibling`] : currentImage
    
    newCurrentImage.classList.add('current')

    const newCurrentImageIndex = Array.from(elements.slideContainer.images.childs).indexOf(newCurrentImage)
    const offset = (newCurrentImage.clientWidth * -(newCurrentImageIndex - (imagesPerView == 1 ? 0 : 1))) + 'px'

    for(let i = 0; i < newCurrentImageIndex - 1; i++){

        hideImage(elements.slideContainer.images.childs[i], i)

    }

    for(let i = newCurrentImageIndex + 2; i < elements.slideContainer.images.childs.length; i++){

        hideImage(elements.slideContainer.images.childs[i], (i - newCurrentImageIndex))
        
    }
    
    function hideImage(image, distanceOfZero) {

        if(image){
            
            image.classList.add('hidden')
    
        }

    }

    elements.slideContainer.images.self.style.transform = `translateX(${offset})`
    
    await alternateClones(newCurrentImageIndex)

}

async function dragCarousel(event) {

    try {

        const events = {
            start: async (e) => {
   
                const clientX = (e.clientX) ? e.clientX : e.targetTouches[0].clientX
                
                dragging = true
                startDrag = clientX
                startTranslate = Number(elements.slideContainer.images.self.style.transform.replace(/\D/g, ''))
                
            },
            move: async (e) => {
    
                if(!dragging){
    
                    return
    
                }

                const clientX = (e.clientX) ? e.clientX : e.targetTouches[0].clientX
                
                const mouseOffset = (startDrag - clientX)
                let offset = startTranslate
    
                if(Math.abs(mouseOffset) > elements.slideContainer.images.childs[0].clientWidth / 2){
    
                    offset += mouseOffset
    
                    const currentImage = Array.from(elements.slideContainer.images.childs).filter((image) => {
            
                        return image.classList.contains('current')
            
                    })[0]
    
                    const direction = Math.sign(mouseOffset) > 0 ? 'right' : 'left'
    
                    scrollCarousel(currentImage, direction)
    
                    dragging = false
    
                }
    
                elements.slideContainer.images.self.style.transform = `translateX(-${offset}px`;
    
            },
            end: async (e) => {
                
                if(!dragging){
                    
                    draggingLeave = true

                }

                startDrag = 0
                dragging = false
                
            },
        }
    
        const eventSelected = events[event]
    
        if(!eventSelected){
    
            throw new Error(`O evento ${event} não existe`)
    
        }
    
        return eventSelected

    } catch(Error) {

        console.error(Error.message)

    }
    
}

async function createClones() {

    let clones = elements.slideContainer.images.self.querySelectorAll('.image.clone')

    if(!clones || clones.length == 0){

        Array.from(elements.slideContainer.images.childs).forEach((image, index, childs) => {

            if(index < imagesPerView){
                
                const cloneImage = image.cloneNode(true)
                
                cloneImage.classList.add('clone')
                
                elements.slideContainer.images.self.appendChild(cloneImage)
                
            } else if(index >= (childs.length - imagesPerView)) {
                
                const cloneImage = image.cloneNode(true)
                
                cloneImage.classList.add('clone')
                
                elements.slideContainer.images.self.insertBefore(cloneImage, childs[0])

            }

        })

        return
        
    }
    
}

async function deleteClones() {

    let clones = elements.slideContainer.images.self.querySelectorAll('.image.clone')

    if(clones && clones.length > 0){

        clones.forEach((clone) => {

            clone.remove()
            
        })
        
    }
    
}

async function alternateClones(currentImageIndex) {

    const backupTransition = getComputedStyle(elements.slideContainer.images.self).getPropertyValue('transition')
    
    let newIndex,
        direction,
        maxImages = elements.slideContainer.images.childs.length,
        maxOriginalsImages = maxImages - imagesPerView * 2,
        mainCloneOffset = imagesPerView == 3 ? 1 : 0,
        firstMainClone = mainCloneOffset,
        lastMainClone = (maxImages - 1) - mainCloneOffset

    if(currentImageIndex == firstMainClone){
        
        newIndex = maxImages - imagesPerView
        direction = 'left'
        
    } else if(currentImageIndex == lastMainClone){
        
        newIndex = imagesPerView - 1
        direction = 'right'
        
    }

    if(newIndex != undefined || newIndex != null){

        console.log(elements.slideContainer.images.childs[newIndex])

        elements.slideContainer.images.self.style.transition = 'none'
        await scrollCarousel(elements.slideContainer.images.childs[newIndex], direction)
        elements.slideContainer.images.self.style.transition = backupTransition

        newIndex = direction == 'left' ? newIndex - 1 : newIndex + 1
        
        await scrollCarousel(elements.slideContainer.images.childs[newIndex], direction)

    }
    
}

async function getClient() {

    if(alreadyViewed.length == clients.length){

        while(alreadyViewed.length > 0){

            alreadyViewed.pop()

        }

    }

    const filteredClients = clients.filter((client, index) => {

        return !alreadyViewed.includes(client)

    })

    const client = filteredClients[0]

    alreadyViewed.push(client)

    return client

}

async function renderClientToDOM(client) {

    elements.slideContainer.images.self.innerHTML = null

    currentClient = client || await getClient()

    elements.infosTop.foto.src = currentClient.photo
    elements.infosTop.clientInfos.name.textContent = currentClient.name
    elements.infosTop.clientInfos.description.textContent = currentClient.description

    if(currentClient.images.length > 0){

        currentClient.images.forEach((image, index) => {

            const projectContainer = document.createElement('div')
            const projectDesktop = document.createElement('img')
            const projectMobile = document.createElement('img')
    
            projectContainer.classList.add('image')
    
            projectDesktop.classList.add('desktop')
            projectMobile.classList.add('mobile')
    
            projectDesktop.src = image.desktop
            projectMobile.src = image.mobile
    
            projectContainer.appendChild(projectDesktop)
            projectContainer.appendChild(projectMobile)
            elements.slideContainer.images.self.appendChild(projectContainer)
    
        })

        elements.slideContainer.images.childs = elements.slideContainer.images.self.childNodes

        await scrollCarousel(elements.slideContainer.images.childs[1])

        elements.slideContainer.images.childs.forEach((image, index) => {

            image.addEventListener('click', async () => {

                if(draggingLeave){

                    draggingLeave = false
    
                    return
    
                }
                
                await scrollCarousel(image)
    
            })
    
        })

    }
    
}